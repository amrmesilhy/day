<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªÙ†Ø¸ÙŠÙ… ÙŠÙˆÙ…Ùƒ â€” Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6f9; --card: #fff; --text: #111; --muted: #555; --accent: #3b82f6; --success: #16a34a; --danger: #ef4444; --orange: #f59e0b;
      --study: #60a5fa; --work: #7c3aed; --life: #34d399; --sport: #f97316;
      --shadow-light: 0 6px 18px rgba(10,20,40,0.06); --shadow-hover: 0 8px 24px rgba(10,20,40,0.12);
      --border: rgba(0,0,0,0.08);
    }
    [data-theme='dark'] {
      --bg: #0b1220; --card: #0f1724; --text: #e6eef8; --muted: #b0c4de; --accent: #60a5fa; --success: #22c55e; --danger: #fb7185; --orange: #f59e0b;
      --shadow-light: 0 6px 18px rgba(0,0,0,0.5); --shadow-hover: 0 8px 24px rgba(0,0,0,0.7);
      --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; font-family: 'Cairo', sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
    body { margin: 0; background: var(--bg); color: var(--text); padding: 18px; }
    .app { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 350px 1fr; gap: 18px; }
    .card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: var(--shadow-light); transition: box-shadow 0.2s, transform 0.2s; }
    .card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .greet { font-size: 20px; font-weight: 700; }
    .sub { color: var(--muted); font-size: 13px; }
    .points { display: flex; align-items: center; gap: 8px; }
    button.btn { background: var(--accent); color: white; padding: 8px 16px; border-radius: 10px; border: none; cursor: pointer; transition: background 0.2s, transform 0.1s; }
    button.btn:hover { background: #2563eb; transform: translateY(-1px); }
    button.ghost { background: transparent; color: var(--accent); border: 1px solid var(--border); transition: border-color 0.2s, color 0.2s; }
    button.ghost:hover { border-color: var(--accent); color: var(--accent); }
    .progress-wrap { margin: 12px 0; }
    .progress { height: 20px; background: #e6eef8; border-radius: 10px; overflow: hidden; transition: width 0.3s ease; }
    [data-theme='dark'] .progress { background: #1f2a44; }
    .progress > i { display: block; height: 100%; background: var(--danger); width: 0; transition: width 0.3s ease, background 0.3s; }
    .quote { font-style: italic; margin: 12px 0; color: var(--muted); font-size: 14px; line-height: 1.5; text-align: center; }
    /* sidebar */
    .sidebar .section { margin-bottom: 12px; }
    .add-btn { width: 100%; padding: 12px; border-radius: 10px; font-weight: 700; }
    .stats { display: flex; gap: 8px; margin-top: 10px; }
    .stat { flex: 1; background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent); padding: 10px; border-radius: 8px; text-align: center; transition: background 0.2s, transform 0.2s; }
    .stat:hover { background: linear-gradient(180deg, rgba(255,255,255,0.1), transparent); transform: translateY(-1px); }
    [data-theme='dark'] .stat { background: linear-gradient(180deg, rgba(255,255,255,0.1), transparent); }
    .tasks { display: flex; flex-direction: column; gap: 8px; }
    .task-card { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 10px; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
    .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .task-card.completed { opacity: 0.7; text-decoration: line-through; }
    .task-meta { display: flex; align-items: center; gap: 10px; }
    .type-dot { width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
    .task-title { font-weight: 700; font-size: 15px; }
    .task-controls { display: flex; gap: 6px; align-items: center; }
    .icon-btn { background: transparent; border: none; cursor: pointer; padding: 6px; border-radius: 6px; transition: background 0.2s; font-size: 16px; }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    [data-theme='dark'] .icon-btn:hover { background: rgba(255,255,255,0.1); }
    /* form */
    .form-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .form-row > * { flex: 1; }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text); transition: border 0.2s, box-shadow 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 5px rgba(59,130,246,0.3); outline: none; }
    label { font-size: 13px; color: var(--muted); display: block; margin-bottom: 6px; }
    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip { padding: 6px 10px; background: transparent; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; transition: background 0.2s, color 0.2s; }
    .chip:hover { background: rgba(0,0,0,0.05); }
    [data-theme='dark'] .chip:hover { background: rgba(255,255,255,0.1); }
    .chip.active { background: var(--accent); color: white; border-color: var(--accent); }
    .timeline { display: flex; flex-direction: column; gap: 6px; }
    .timeline-item { padding: 12px; border-radius: 8px; border-left: 4px solid var(--accent); background: linear-gradient(90deg, transparent, rgba(0,0,0,0.02)); transition: border-left-color 0.2s, transform 0.2s; }
    .timeline-item:hover { border-left-color: var(--success); transform: translateX(4px); }
    [data-theme='dark'] .timeline-item { background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05)); }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 12px; background: linear-gradient(90deg, var(--accent), var(--success)); font-weight: 700; color: white; transition: transform 0.2s; }
    .badge:hover { transform: scale(1.05); }
    .controls-row { display: flex; gap: 8px; align-items: center; }
    .level { font-weight: 800; color: var(--accent); }
    footer { margin-top: 18px; text-align: center; color: var(--muted); font-size: 13px; display: flex; justify-content: center; gap: 10px; }
    footer button { font-size: 13px; padding: 4px 8px; }
    @media (max-width: 900px) { .app { grid-template-columns: 1fr; padding: 12px; } }
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .modal-content { animation: fadeIn 0.2s ease-out; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="sidebar">
      <div class="card">
        <header>
          <div>
            <div class="greet" id="greet">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ Ø¹Ù…Ø±Ùˆ â˜€ï¸</div>
            <div class="sub" id="dateStr">--</div>
          </div>
          <div class="points">
            <div style="text-align:right">
              <div class="sub">Ù†Ù‚Ø§Ø·Ùƒ</div>
              <div id="points" style="font-weight:900">0</div>
            </div>
            <button class="btn" id="themeToggle">ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ</button>
          </div>
        </header>
        <div class="progress-wrap">
          <div class="sub">Ù…Ø¤Ø´Ø± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="progress"><i id="progressFill"></i></div>
          <div class="sub" id="progressText"></div>
        </div>
        <div class="quote" id="quote">"Ø­Ù…Ù‘Ù„ Ø§Ù‚ØªØ¨Ø§Ø³ ØªØ­ÙÙŠØ²ÙŠ"</div>
        <div style="margin-top:12px">
          <button class="add-btn btn" id="openAdd">Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© +</button>
        </div>
        <div class="stats">
          <div class="stat">
            <div class="sub">Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</div>
            <div id="countToday">0</div>
          </div>
          <div class="stat">
            <div class="sub">Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</div>
            <div id="weekDone">0</div>
          </div>
          <div class="stat">
            <div class="sub">Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
            <div id="streakDisplay">0 Ø£ÙŠØ§Ù…</div>
          </div>
        </div>
      </div>

      <div class="card section" style="margin-top:12px">
        <div class="sub">Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</div>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
          <div class="chip active" data-filter="all">Ø§Ù„ÙƒÙ„</div>
          <div class="chip" data-filter="study">Ø¯Ø±Ø§Ø³Ø© ğŸ“š</div>
          <div class="chip" data-filter="work">Ø´ØºÙ„ ğŸ’»</div>
          <div class="chip" data-filter="life">Ø­ÙŠØ§ØªÙŠ ğŸƒâ€â™‚ï¸</div>
          <div class="chip" data-filter="sport">Ø±ÙŠØ§Ø¶Ø© ğŸ‹ï¸</div>
        </div>
      </div>

      <div class="card section" style="margin-top:12px">
        <div class="sub">Ø´Ø§Ø±Ø§ØªÙƒ</div>
        <div id="badgesArea" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:900;font-size:20px">Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…Ùƒ</div>
            <div class="sub">Ø´ÙˆÙ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ… ÙˆØ¹Ø¯Ù‘Ù„ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø³Ø±Ø¹Ø©</div>
          </div>
          <div class="controls-row">
            <div class="sub">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span class="level" id="level">1</span></div>
            <button class="ghost" id="openHistory">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="filters" id="filters">
            <input type="date" id="filterDate" class="chip" style="padding:8px;" />
            <select id="filterPriority" class="chip"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="high">Ø¹Ø§Ù„ÙŠ</option><option value="medium">Ù…ØªÙˆØ³Ø·</option><option value="low">Ù…Ù†Ø®ÙØ¶</option></select>
            <select id="filterType" class="chip"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="study">Ø¯Ø±Ø§Ø³Ø©</option><option value="work">Ø´ØºÙ„</option><option value="life">Ø­ÙŠØ§ØªÙŠ</option><option value="sport">Ø±ÙŠØ§Ø¶Ø©</option></select>
            <input id="searchTxt" class="chip" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…..." />
          </div>
        </div>

        <div style="margin-top:12px" id="tasksContainer"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙÙŠØ²</div>
          <div class="sub">ÙƒÙ„Ù…Ø§ ØªÙ†Ø¬Ø² ÙŠÙØªØ­Ù„Ùƒ Ø¹Ù†Ø§ØµØ± Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù‚ØªØ¨Ø§Ø³Ø§Øª ØªØ­ÙÙŠØ²ÙŠØ©</div>
        </div>
        <div style="margin-top:10px" id="motivationBoard"></div>
      </div>

      <footer>
        Ù…Ù†ØµØ© "ØªÙ†Ø¸ÙŠÙ… ÙŠÙˆÙ…Ùƒ" â€” Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­. Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù†Ù‚Ø¯Ø± Ù†ÙˆØµÙ‘Ù„ Firebase Ù„Ø§Ø­Ù‚Ù‹Ø§.
        <button class="ghost" id="exportData">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <label for="importFile" class="ghost" style="cursor:pointer;">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
        <input type="file" id="importFile" style="display:none;" accept=".json">
      </footer>
    </div>
  </div>

  <!-- Add / Edit Modal -->
  <div id="modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:999">
    <div class="modal-content" style="width:720px;max-width:96%;background:var(--card);border-radius:12px;padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Ø£Ø¶Ù / Ø¹Ø¯Ù‘Ù„ Ù…Ù‡Ù…Ø©</div>
        <button id="closeModal" class="icon-btn">âœ–</button>
      </div>
      <div style="margin-top:12px">
        <div class="form-row">
          <div>
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <input id="taskTitle" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø°Ø§ÙƒØ±Ø© Ù„ØºØ© Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" required />
          </div>
          <div>
            <label>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
            <select id="taskPriority"><option value="high">Ø¹Ø§Ù„ÙŠ</option><option value="medium">Ù…ØªÙˆØ³Ø·</option><option value="low">Ù…Ù†Ø®ÙØ¶</option></select>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
            <select id="taskType"><option value="study">Ø¯Ø±Ø§Ø³Ø©</option><option value="work">Ø´ØºÙ„</option><option value="life">Ø­ÙŠØ§ØªÙŠ</option><option value="sport">Ø±ÙŠØ§Ø¶Ø©</option></select>
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°</label>
            <input id="taskDate" type="date" required />
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input id="taskTime" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹: 45" min="1" />
          </div>
          <div>
            <label>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="taskStartTime" type="time" />
          </div>
        </div>
        <div style="margin-bottom:8px">
          <label>Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù†Ù‚Ø§Ø·</label>
          <input id="taskPoints" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹: 10" min="1" required />
        </div>
        <div style="margin-bottom:8px">
          <label>ÙˆØµÙ Ù…Ø®ØªØµØ±</label>
          <textarea id="taskDesc" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="ghost" id="saveTask">Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.4);z-index:999">
    <div class="modal-content" style="width:900px;max-width:96%;background:var(--card);border-radius:12px;padding:16px;max-height:80vh;overflow:auto">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:900">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
        <button id="closeHistory" class="icon-btn">âœ–</button>
      </div>
      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <label>Ø§Ø¨Ø­Ø« Ø¨ØªØ§Ø±ÙŠØ®</label>
          <input id="histDate" type="date" />
          <label>Ù†ÙˆØ¹</label>
          <select id="histType"><option value="all">Ø§Ù„ÙƒÙ„</option><option value="study">Ø¯Ø±Ø§Ø³Ø©</option><option value="work">Ø´ØºÙ„</option><option value="life">Ø­ÙŠØ§ØªÙŠ</option><option value="sport">Ø±ÙŠØ§Ø¶Ø©</option></select>
          <input id="histSearch" class="chip" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª..." />
        </div>
        <div style="margin-top:12px" id="historyList"></div>
        <div style="margin-top:12px">
          <div class="sub">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div class="stat">
              <div class="sub">Ù…Ø¹Ø¯Ù„ Ø¥Ù†Ø¬Ø§Ø² Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
              <div id="statWeekly">0%</div>
            </div>
            <div class="stat">
              <div class="sub">Ù…Ø¹Ø¯Ù„ Ø¥Ù†Ø¬Ø§Ø² Ø´Ù‡Ø±ÙŠ</div>
              <div id="statMonthly">0%</div>
            </div>
            <div class="stat">
              <div class="sub">Ø£ÙØ¶Ù„ ÙŠÙˆÙ…</div>
              <div id="bestDay">-</div>
            </div>
            <div class="stat">
              <div class="sub">Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
              <div id="streakDisplay">0 Ø£ÙŠØ§Ù…</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Data model in localStorage ---
    const LS_KEY = 'taym_tasks_v1';
    const USER_KEY = 'taym_user_v1';

    const defaultUser = {name:'Ø¹Ù…Ø±Ùˆ', points:0, level:1, lastActive:null, streak:0, badges:[]};
    const quotes = [
      'Ø§Ø¨Ø¯Ø£ ØµØºÙŠØ±Ù‹Ø§ Ù„ÙƒÙ† Ø§Ø¨Ø¯Ø£ØŒ ÙØ§Ù„ØªÙ‚Ø¯Ù‘Ù… Ø£Ù‡Ù… Ù…Ù† Ø§Ù„ÙƒÙ…Ø§Ù„.',
      'Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© ØªØµÙ†Ø¹ Ø§Ù„ÙØ±Ù‚ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù„Ø­Ø¸Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©.',
      'ÙƒÙ„ Ù…Ù‡Ù…Ø© ØµØºÙŠØ±Ø© ØªÙ‚Ø±Ø¨Ùƒ Ù…Ù† Ø­Ù„Ù… ÙƒØ¨ÙŠØ± â€” Ø§Ø³ØªÙ…Ø±.',
      'Ø«Ù‚Ø© Ø§Ù„ÙŠÙˆÙ… Ù‡ÙŠ Ø«Ù…Ø±Ø© Ø¹Ù…Ù„ Ø§Ù„Ø£Ù…Ø³.',
      'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: Ø§Ù„Ø¥ØµØ±Ø§Ø± ÙŠØ¨Ù†ÙŠ Ø§Ù„Ù†Ø¬Ø§Ø­.',
      'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3: ÙƒÙ„ ÙŠÙˆÙ… Ø®Ø·ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø© Ù†Ø­Ùˆ Ø§Ù„Ø£ÙØ¶Ù„.',
      'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4: Ø£Ù†Øª Ù‚Ø§Ø¯Ø± Ø¹Ù„Ù‰ Ø£ÙƒØ«Ø± Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„.',
      'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5: Ø§Ù„Ù†Ø¬Ø§Ø­ Ù‡Ùˆ Ù†ØªÙŠØ¬Ø© Ø®Ø·ÙˆØ§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.'
    ];

    function uid(){return Date.now()+Math.floor(Math.random()*999)}

    // Debounce function to limit save frequency
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // load/save
    function load(){
      const raw = localStorage.getItem(LS_KEY); 
      let db = raw?JSON.parse(raw):{tasks:[],history:[]};
      const rawUser = localStorage.getItem(USER_KEY);
      let user = rawUser?JSON.parse(rawUser):defaultUser;
      const theme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', theme);
      themeToggle.textContent = theme === 'dark' ? 'ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ' : 'ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ';
      return {db,user};
    }
    const save = debounce((db,user) => {
      localStorage.setItem(LS_KEY,JSON.stringify(db));
      localStorage.setItem(USER_KEY,JSON.stringify(user));
      // Optional: Show a subtle save confirmation
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸', 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… Ø­ÙØ¸Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§');
    }, 500);

    // UI refs
    const greetEl = document.getElementById('greet');
    const dateStr = document.getElementById('dateStr');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const quoteEl = document.getElementById('quote');
    const openAdd = document.getElementById('openAdd');
    const modal = document.getElementById('modal');
    const closeModal = document.getElementById('closeModal');
    const saveTaskBtn = document.getElementById('saveTask');
    const tasksContainer = document.getElementById('tasksContainer');
    const pointsEl = document.getElementById('points');
    const countTodayEl = document.getElementById('countToday');
    const weekDone = document.getElementById('weekDone');
    const streakDisplay = document.getElementById('streakDisplay');
    const badgesArea = document.getElementById('badgesArea');
    const levelEl = document.getElementById('level');
    const themeToggle = document.getElementById('themeToggle');
    const openHistory = document.getElementById('openHistory');
    const historyModal = document.getElementById('historyModal');
    const closeHistory = document.getElementById('closeHistory');
    const historyList = document.getElementById('historyList');
    const histSearch = document.getElementById('histSearch');

    // form fields
    const taskTitle = document.getElementById('taskTitle');
    const taskPriority = document.getElementById('taskPriority');
    const taskType = document.getElementById('taskType');
    const taskDate = document.getElementById('taskDate');
    const taskTime = document.getElementById('taskTime');
    const taskStartTime = document.getElementById('taskStartTime');
    const taskPoints = document.getElementById('taskPoints');
    const taskDesc = document.getElementById('taskDesc');

    let {db,user} = load();

    // helpers
    function todayISO(d=new Date()){return d.toISOString().slice(0,10)}
    function friendlyDate(iso){
      const d=new Date(iso);
      return d.toLocaleDateString('ar-EG',{weekday:'short',day:'numeric',month:'short'});
    }

    // greet & date
    function updateGreet(){
      const h = new Date().getHours();
      let g = h < 12 ? 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ Ø¹Ù…Ø±Ùˆ â˜€ï¸' : h < 17 ? 'Ù†Ù‡Ø§Ø±Ùƒ Ø³Ø¹ÙŠØ¯ ÙŠØ§ Ø¹Ù…Ø±Ùˆ ğŸŒ' : 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø· ÙŠØ§ Ø¹Ù…Ø±Ùˆ ğŸŒ™';
      greetEl.textContent = g;
      dateStr.textContent = new Date().toLocaleDateString('ar-EG',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
      // daily quote by date, unlock more with levels
      const baseQuotes = quotes.slice(0,4);
      const unlockedQuotes = quotes.slice(4, 4 + Math.max(0, user.level - 1));
      const allQuotes = baseQuotes.concat(unlockedQuotes);
      const q = allQuotes[new Date().getDate() % allQuotes.length];
      quoteEl.textContent = '"'+q+'"';
    }

    function playSuccess(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='sine';o.frequency.value=880;g.gain.value=0.06; o.connect(g);g.connect(ctx.destination);o.start();
        setTimeout(()=>{o.stop();ctx.close()},160);
      }catch(e){}
    }

    // render tasks
    function renderTasks(filter={date:todayISO(),priority:'all',type:'all',search:''}){
      const list = db.tasks.filter(t=>{
        if(filter.date && t.date!==filter.date) return false;
        if(filter.priority!=='all' && t.priority!==filter.priority) return false;
        if(filter.type!=='all' && t.type!==filter.type) return false;
        if(filter.search && !t.title.toLowerCase().includes(filter.search.toLowerCase()) && !t.desc.toLowerCase().includes(filter.search.toLowerCase())) return false;
        return true;
      });
      tasksContainer.innerHTML = '';
      if (list.length === 0) {
        tasksContainer.innerHTML = '<div class="sub fade-in" style="text-align:center;padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…. Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©!</div>';
      }
      list.forEach(t=>{
        const card = document.createElement('div');card.className=`task-card ${t.done ? 'completed' : ''} fade-in`;
        const meta = document.createElement('div');meta.className='task-meta';
        const dot = document.createElement('span');dot.className='type-dot';
        dot.style.background = t.type==='study' ? 'var(--study)' : t.type==='work' ? 'var(--work)' : t.type==='life' ? 'var(--life)' : 'var(--sport)';
        const title = document.createElement('div');
        title.innerHTML=`<div class='task-title'>${t.title}</div><div class='sub'>${t.time||''} Ø¯Ù‚ÙŠÙ‚Ø© â€¢ ${t.points||0} Ù†Ù‚Ø·Ø©${t.startTime ? ' â€¢ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø³Ø§Ø¹Ø© ' + t.startTime : ''}${t.desc ? ' â€¢ ' + t.desc.slice(0,50) + (t.desc.length>50?'...':'') : ''}</div>`;
        meta.appendChild(dot);meta.appendChild(title);
        const controls = document.createElement('div');controls.className='task-controls';
        const cb = document.createElement('input');cb.type='checkbox';cb.checked = !!t.done;cb.addEventListener('change',()=>toggleDone(t.id,cb.checked));
        const edit = document.createElement('button');edit.className='icon-btn';edit.innerHTML='âœ';edit.title='ØªØ¹Ø¯ÙŠÙ„';edit.addEventListener('click',()=>openEdit(t.id));
        const del = document.createElement('button');del.className='icon-btn';del.innerHTML='ğŸ—‘';del.title='Ø­Ø°Ù';del.addEventListener('click',()=>deleteTask(t.id));
        controls.appendChild(cb);controls.appendChild(edit);controls.appendChild(del);
        card.appendChild(meta);card.appendChild(controls);
        tasksContainer.appendChild(card);
      });
      countTodayEl.textContent = list.length;
      updateProgress();
    }

    function addTask(data){
      const task = Object.assign({id:uid(),title:'',desc:'',time:0,priority:'medium',type:'study',date:todayISO(),points:5,done:false,created:new Date().toISOString(),startTime:''},data);
      db.tasks.push(task); 
      save(db,user); // Auto-save
      renderTasks(currentFilter);
      showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©','ØªÙ… Ø­ÙØ¸ Ù…Ù‡Ù…ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­');
      notify('Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©', task.title);
      if (task.startTime) scheduleNotification(task);
    }

    function scheduleNotification(task) {
      if (!task.startTime) return;
      const [hours, minutes] = task.startTime.split(':').map(Number);
      const taskTime = new Date(task.date);
      taskTime.setHours(hours, minutes, 0);
      const now = new Date();
      const diff = taskTime - now;
      if (diff > 0 && diff <= 24*60*60*1000) {
        setTimeout(() => {
          showToast('ØªØ°ÙƒÙŠØ±!', `Ø§Ù„Ù…Ù‡Ù…Ø© "${task.title}" ØªØ¨Ø¯Ø£ Ø§Ù„Ø¢Ù†!`);
          requestNotification('ØªØ°ÙƒÙŠØ± Ø¨Ù…Ù‡Ù…Ø©', task.title);
        }, diff);
        setTimeout(() => {
          if (!task.done) showToast('ØªØ°ÙƒÙŠØ±!', `Ø§Ù„Ù…Ù‡Ù…Ø© "${task.title}" Ù…ØªØ£Ø®Ø±Ø©!`);
        }, diff + 15*60*1000); // ØªØ°ÙƒÙŠØ± Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒØªÙ…Ù„
      }
    }

    function openEdit(id){
      const t = db.tasks.find(x=>x.id===id); if(!t) return;
      taskTitle.value=t.title;taskPriority.value=t.priority;taskType.value=t.type;taskDate.value=t.date;taskTime.value=t.time;taskPoints.value=t.points;taskDesc.value=t.desc;taskStartTime.value=t.startTime||'';
      modal.style.display='flex'; saveTaskBtn.dataset.editId = id;
    }

    function deleteTask(id){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
      db.tasks = db.tasks.filter(x=>x.id!==id); 
      save(db,user); // Auto-save
      renderTasks(currentFilter);
      showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
    }

    function toggleDone(id,done){
      const t = db.tasks.find(x=>x.id===id); if(!t) return; t.done=done;
      if(done){
        db.history.push(Object.assign({},t,{completedAt:new Date().toISOString()}));
        user.points += (t.points||0);
        awardBadges();
        playSuccess();
        const messages = ['Ø¨Ø±Ø§ÙÙˆ ÙŠØ§ Ø¨Ø·Ù„! ğŸ‘', 'Ø®Ø·ÙˆØ© Ø£Ù‚Ø±Ø¨ Ù„Ù‡Ø¯ÙÙƒ ğŸ’ª', 'Ø±Ø§Ø¦Ø¹ØŒ Ø§Ø³ØªÙ…Ø± Ù‡ÙƒØ°Ø§! ğŸš€', 'Ø£Ø­Ø³Ù†ØªØŒ Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©! ğŸ¥‡'];
        showToast(messages[Math.floor(Math.random() * messages.length)],'Ù„Ù‚Ø¯ Ø±Ø¨Ø­Øª '+(t.points||0)+' Ù†Ù‚Ø·Ø©');
        requestNotification('Ù…Ù‡Ù…ØªÙƒ Ø§Ù†Ø¬Ø²Øª',''+t.title+' â€” +' + (t.points||0) + ' Ù†Ù‚Ø§Ø·');
      }
      save(db,user); // Auto-save
      renderTasks(currentFilter); renderBadges(); renderMotivation(); updateUserUI();
    }

    function awardBadges(){
      const today = todayISO();
      const doneToday = db.history.filter(h=>h.date===today).length;
      if(doneToday>=5 && !user.badges.includes('day_gold')) {
        user.badges.push('day_gold');
        showToast('Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©!', 'Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ…');
      }
      user.streak = getConsecutiveDays();
      if(user.streak>=7 && !user.badges.includes('streak7')) {
        user.badges.push('streak7');
        showToast('Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©!', 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ ğŸ’ª');
      }
      const hardDone = db.history.find(h=>h.priority==='high');
      if(hardDone && !user.badges.includes('warrior')) {
        user.badges.push('warrior');
        showToast('Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©!', 'Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ âš”ï¸');
      }
      const totalPoints = user.points;
      if(totalPoints>=500 && !user.badges.includes('master')) {
        user.badges.push('master');
        showToast('Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©!', 'Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ù…ØªÙ…ÙƒÙ† ğŸ†');
      }
      save(db,user); // Auto-save
    }

    function getConsecutiveDays(){
      const dates = Array.from(new Set(db.history.map(h=>h.date))).sort().reverse();
      let count=0; let cur = todayISO();
      while(dates.includes(cur)){
        count++; const d = new Date(cur); d.setDate(d.getDate()-1); cur = todayISO(d);
      }
      return count;
    }

    function requestNotification(title,body){
      if(Notification && Notification.permission==='granted'){
        new Notification(title,{body,icon:'https://via.placeholder.com/32'});
      }else if(Notification){
        Notification.requestPermission();
      }
    }

    function notify(t,b){
      if(Notification && Notification.permission!=='granted'){
        Notification.requestPermission().then(()=>{});
      }
      if(Notification && Notification.permission==='granted'){
        new Notification(t,{body,icon:'https://via.placeholder.com/32'});
      }
    }

    function showToast(title,msg){
      const el = document.createElement('div');
      el.style.position='fixed';el.style.left='50%';el.style.transform='translateX(-50%)';el.style.bottom='40px';
      el.style.background='var(--card)';el.style.padding='12px 16px';el.style.borderRadius='10px';
      el.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';el.style.transition='opacity 0.3s';
      el.innerHTML=`<strong>${title}</strong><div style='color:var(--muted)'>${msg}</div>`;
      document.body.appendChild(el);
      setTimeout(() => el.style.opacity=0, 2400);
      setTimeout(() => el.remove(), 2700);
    }

    function updateProgress(){
      const today = todayISO();
      const tasksToday = db.tasks.filter(t=>t.date===today);
      const done = tasksToday.filter(t=>t.done).length;
      const total = tasksToday.length || 1;
      const pct = Math.round((done/total)*100);
      progressFill.style.width = pct+'%';
      progressFill.style.background = pct<50 ? 'var(--danger)' : pct<80 ? 'var(--orange)' : 'var(--success)';
      progressText.textContent = pct + '% Ù…ÙÙ†Ø¬Ø²';
      if (pct === 100 && tasksToday.length > 0) {
        showToast('Ø¥Ù†Ø¬Ø§Ø² ÙƒØ§Ù…Ù„!', 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ØŒ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…! ğŸ‰');
        requestNotification('Ø¥Ù†Ø¬Ø§Ø² ÙƒØ§Ù…Ù„!', 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ØŒ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…!');
      }
    }

    function updateUserUI(){
      pointsEl.textContent = user.points;
      levelEl.textContent = user.level;
      weekDone.textContent = db.history.filter(h=>{
        const d = new Date(h.completedAt); const now=new Date();
        const diff=(now-d)/(1000*60*60*24); return diff<=7;
      }).length;
      streakDisplay.textContent = `${user.streak} Ø£ÙŠØ§Ù…`;
      renderBadges();
    }

    function renderBadges(){
      badgesArea.innerHTML='';
      user.badges.forEach(b=>{
        const el=document.createElement('div');el.className='badge';
        el.textContent = b==='day_gold' ? 'Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø°Ù‡Ø¨ÙŠ ğŸ…' : b==='streak7' ? 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠ ğŸ’ª' : b==='warrior' ? 'Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ âš”ï¸' : 'Ø§Ù„Ø³ÙŠØ¯ Ø§Ù„Ù…ØªÙ…ÙƒÙ† ğŸ†';
        badgesArea.appendChild(el);
      });
    }

    // Motivation board
    function renderMotivation(){
      const board = document.getElementById('motivationBoard');
      board.innerHTML='';
      const unlocked = Math.min(Math.floor(user.points/50), 6);
      for(let i=0;i<7;i++){
        const card = document.createElement('div');card.className='card fade-in';
        card.style.display='inline-block';card.style.marginRight='8px';card.style.width='140px';card.style.verticalAlign='top';card.style.transition='opacity 0.5s';
        if(i<=unlocked){
          card.innerHTML=`<div style='font-weight:900'>Ø¹Ù†ØµØ± ${i+1}</div><div class='sub'>Ù…ÙØªÙˆØ­ - Ø§Ù‚ØªØ¨Ø§Ø³ ØªØ­ÙÙŠØ²ÙŠ Ø¥Ø¶Ø§ÙÙŠ Ù…ÙØªÙˆØ­!</div>`;
        }else{
          card.innerHTML=`<div style='font-weight:900'>Ø¹Ù†ØµØ± ${i+1}</div><div class='sub'>Ù‚ÙÙ„ â€” Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ${ (i+1)*50 } Ù†Ù‚Ø·Ø©</div>`;
          card.style.opacity=0.6;
        }
        board.appendChild(card);
      }
    }

    function openModal(){
      modal.style.display='flex';
      saveTaskBtn.dataset.editId='';
      taskTitle.value='';taskPriority.value='medium';taskType.value='study';taskDate.value=todayISO();taskTime.value='';taskPoints.value=10;taskDesc.value='';taskStartTime.value='';
      taskTitle.focus();
    }

    function closeModalFn(){
      modal.style.display='none';
    }

    saveTaskBtn.addEventListener('click',()=>{
      if(!taskTitle.value.trim()){alert('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©');return}
      if(!taskDate.value){alert('Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ†ÙÙŠØ°');return}
      if(!taskPoints.value || taskPoints.value<1){alert('Ø­Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ù…ÙƒØ§ÙØ£Ø© ØµØ§Ù„Ø­Ø©');return}
      const id = saveTaskBtn.dataset.editId;
      const payload={
        title:taskTitle.value,priority:taskPriority.value,type:taskType.value,
        date:taskDate.value,time:taskTime.value,startTime:taskStartTime.value,
        points:parseInt(taskPoints.value)||5,desc:taskDesc.value
      };
      if(id){
        const t = db.tasks.find(x=>x.id==id); Object.assign(t,payload); 
        save(db,user); // Auto-save
        renderTasks(currentFilter); closeModalFn();
        showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
      }else{
        addTask(payload); closeModalFn();
      }
      // level up logic
      const next = Math.floor(user.points/100)+1;
      if(next>user.level){
        user.level=next;
        showToast('ğŸ‰ Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯',`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${user.level}`);
        notify('Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯', `ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${user.level}`);
        updateGreet();
        renderMotivation();
        save(db,user); // Auto-save
      }
      updateUserUI();
    });

    openAdd.addEventListener('click',openModal);
    closeModal.addEventListener('click',closeModalFn);

    themeToggle.addEventListener('click',()=>{
      const t = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
      document.documentElement.setAttribute('data-theme',t);
      themeToggle.textContent = t==='dark'?'ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ':'ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ';
      localStorage.setItem('theme', t);
    });

    // filters
    const filterDate = document.getElementById('filterDate');
    const filterPriority = document.getElementById('filterPriority');
    const filterType = document.getElementById('filterType');
    const searchTxt = document.getElementById('searchTxt');
    let currentFilter = {date:todayISO(),priority:'all',type:'all',search:''};
    filterDate.value = todayISO();
    filterDate.addEventListener('change',()=>{currentFilter.date=filterDate.value; renderTasks(currentFilter)});
    filterPriority.addEventListener('change',()=>{currentFilter.priority=filterPriority.value; renderTasks(currentFilter)});
    filterType.addEventListener('change',()=>{currentFilter.type=filterType.value; renderTasks(currentFilter)});
    searchTxt.addEventListener('input',()=>{currentFilter.search=searchTxt.value; renderTasks(currentFilter)});

    // chips
    document.querySelectorAll('.chip[data-filter]').forEach(c=>{
      c.addEventListener('click',()=>{
        document.querySelectorAll('.chip[data-filter]').forEach(chip=>chip.classList.remove('active'));
        c.classList.add('active');
        const f=c.dataset.filter;
        if(f==='all'){filterType.value='all';currentFilter.type='all'}
        else{filterType.value=f;currentFilter.type=f}
        renderTasks(currentFilter);
      });
    });

    // history
    openHistory.addEventListener('click',()=>{historyModal.style.display='flex'; renderHistory();});
    closeHistory.addEventListener('click',()=>{historyModal.style.display='none';});
    document.getElementById('histDate').addEventListener('change',renderHistory);
    document.getElementById('histType').addEventListener('change',renderHistory);
    histSearch.addEventListener('input',renderHistory);

    function renderHistory(){
      const date = document.getElementById('histDate').value;
      const type = document.getElementById('histType').value;
      const search = histSearch.value.toLowerCase();
      let list = db.history.slice().reverse();
      if(date) list = list.filter(h=>h.date===date);
      if(type && type!=='all') list = list.filter(h=>h.type===type);
      if(search) list = list.filter(h=>h.title.toLowerCase().includes(search) || h.desc.toLowerCase().includes(search));
      historyList.innerHTML='';
      if (list.length === 0) {
        historyList.innerHTML = '<div class="sub" style="text-align:center;padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
      }
      list.forEach(h=>{
        const el=document.createElement('div');el.className='timeline-item fade-in';
        el.innerHTML=`<div style='display:flex;justify-content:space-between'><div><strong>${h.title}</strong><div class='sub'>${friendlyDate(h.date)} â€¢ ${h.points} Ù†Ù‚Ø·Ø© â€¢ ${h.type}</div></div><div class='sub'>${h.priority==='high'?'Ø¹Ø§Ù„ÙŠ':h.priority==='medium'?'Ù…ØªÙˆØ³Ø·':'Ù…Ù†Ø®ÙØ¶'}</div></div>`;
        historyList.appendChild(el);
      });
      // stats compute
      const weeklyTasks = db.history.filter(h=>{
        const d=new Date(h.completedAt); const now=new Date();
        const diff=(now-d)/(1000*60*60*24); return diff<=7;
      });
      const weeklyTotal = db.tasks.filter(t=>{
        const d=new Date(t.created); const now=new Date();
        const diff=(now-d)/(1000*60*60*24); return diff<=7;
      }).length || 1;
      document.getElementById('statWeekly').textContent = Math.round((weeklyTasks.length/weeklyTotal)*100)+'%';
      const monthlyTasks = db.history.filter(h=>{
        const d=new Date(h.completedAt); const now=new Date();
        const diff=(now-d)/(1000*60*60*24); return diff<=30;
      });
      const monthlyTotal = db.tasks.filter(t=>{
        const d=new Date(t.created); const now=new Date();
        const diff=(now-d)/(1000*60*60*24); return diff<=30;
      }).length || 1;
      document.getElementById('statMonthly').textContent = Math.round((monthlyTasks.length/monthlyTotal)*100)+'%';
      // best day
      const counts = {};
      db.history.forEach(h=>{counts[h.date]=(counts[h.date]||0)+1});
      const best = Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0]||'-';
      document.getElementById('bestDay').textContent = best==='-'?'-':friendlyDate(best);
      document.getElementById('streakDisplay').textContent = `${user.streak} Ø£ÙŠØ§Ù…`;
    }

    // export/import
    document.getElementById('exportData').addEventListener('click', () => {
      const data = JSON.stringify({db, user}, null, 2);
      const blob = new Blob([data], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `taym_data_${todayISO()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±', 'ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙƒÙ…Ù„Ù JSON');
    });

    document.getElementById('importFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          db = imported.db || {tasks:[],history:[]};
          user = imported.user || defaultUser;
          save(db, user); // Auto-save
          renderTasks(currentFilter);
          updateUserUI();
          renderMotivation();
          renderBadges();
          updateGreet();
          showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯', 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­!');
        } catch (err) {
          showToast('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØªÙ‡');
        }
      };
      reader.readAsText(file);
    });

    // load initial
    updateGreet();
    renderTasks(currentFilter);
    renderMotivation();
    updateUserUI();
    renderBadges();

    // helper to save date field default
    taskDate.value = todayISO();

    // small UX: if no tasks, show placeholder
    if(db.tasks.length===0){
      addTask({title:'Ù…Ø°Ø§ÙƒØ±Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©',desc:'Ø§Ù‚Ø±Ø£ 2 ØµÙØ­Ø©',time:30,priority:'medium',type:'study',date:todayISO(),points:10});
      addTask({title:'Ù…Ø´Ø±ÙˆØ¹ ÙØ±ÙˆÙ†Øª Ø§Ù†Ø¯',desc:'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©',time:60,priority:'high',type:'work',date:todayISO(),points:20,startTime:'14:00'});
    }

    // expose replace with save on unload
    window.addEventListener('beforeunload',()=>save(db,user));

    // keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        openModal();
      }
      if (e.key === 'Escape' && modal.style.display === 'flex') {
        closeModalFn();
      }
    });

    // check overdue tasks every minute
    setInterval(() => {
      db.tasks.forEach(task => {
        if (task.done || !task.startTime) return;
        const [hours, minutes] = task.startTime.split(':').map(Number);
        const taskTime = new Date(task.date);
        taskTime.setHours(hours, minutes, 0);
        const now = new Date();
        if (now > taskTime + 15*60*1000) {
          showToast('Ù…Ù‡Ù…Ø© Ù…ØªØ£Ø®Ø±Ø©!', `Ø§Ù„Ù…Ù‡Ù…Ø© "${task.title}" Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯!`);
        }
      });
    }, 60*1000);
  </script>
</body>
</html>
